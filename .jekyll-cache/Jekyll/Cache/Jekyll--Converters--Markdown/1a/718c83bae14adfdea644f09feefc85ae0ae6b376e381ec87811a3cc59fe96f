I"È:<p>Ok so symfony created a new <a href="https://symfony.com/doc/current/components/mime.html">mime</a> component to create emails, and a new <a href="https://symfony.com/doc/current/mailer.html">mailer</a> component to send those. Letâ€™s bundle them up and see what we end up with!</p>

<p>If you prefer to skip to the end, just install the <a href="https://packagist.org/packages/disjfa/mail-bundle">bundle</a> we made and enjoy!</p>

<h3 id="why">Why?</h3>

<p>Why we started this. We made a lot of symfony apps and in every app we started a new mail system, awesome they were. But after the third or fourth we knew the basics. But as is in every project we forgot to make a bundle and kept copy pasting the data missing stuff or re-create the methods over and over again. Se lets make a bundle that can be used and re-used.</p>

<p>This will be a setup for the core data of the bundle, so code.</p>

<h3 id="history">History</h3>

<p>So first up, a bit of history in my words. So probably none is true, but i like it. The guys (guys as in plural men and women of course) from symfony used a old package swiftmailer, so they ended up maintaining it. This could be cleaner and nicer, so they made that with the mime component, decoupling the sending in the mailer component. In the way making the components they set it up in a way to make it fancier and add magic. Awesome, now lets get into the code.</p>

<h3 id="setup">Setup</h3>

<p>This article will talk about the setup, opinionated and the way we would set things up. We will have ideas and opinions. And if you differ from those, you will hopefully learn a thing or two to get you on your own way.</p>

<p>But the basic setup is:</p>
<ul>
  <li>make it easy to set up emails in your symfony application.</li>
  <li>make use of a database, so you can manage and your clients can tinker.</li>
  <li>generate emails using the <a href="Inlining CSS Styles">Inlining CSS Styles</a> and <a href="https://symfony.com/doc/current/mailer.html#inky-email-templating-language">Inky Email Templating Language</a>.</li>
  <li>add a way to test and see what we are actually doing</li>
</ul>

<h3 id="lets-go">Letâ€™s go</h3>

<p>You can install the bundle by just installing it in your symfony application. This will setup everything you need to start emailing.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">composer require disjfa/mail-bundle</span>
</code></pre></div></div>

<p>In the basic setup you can just add your own email, An email should have a name, subject and content. You do need one <code class="highlighter-rouge">.env</code> variable named <code class="highlighter-rouge">DISJFA_MAIL_FROM</code> for the from email address.</p>

<h3 id="create-an-email">Create an email</h3>

<p>So now you need to create your own email. There is an interface for that! If you implement the interface the system will auto register the email so you are done. Lets check it.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">Disjfa\MailBundle\Mail</span><span class="p">;</span>

<span class="kd">interface</span> <span class="nc">MailInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getName</span><span class="p">();</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getSubject</span><span class="p">();</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getContent</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>So your class will look something like this.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="o">...</span><span class="p">;</span>

<span class="kn">use</span> <span class="nn">Disjfa\MailBundle\Mail\MailInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">ExampleMail</span> <span class="k">implements</span> <span class="nx">MailInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getName</span><span class="p">()</span><span class="o">:</span> <span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">'app.example'</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getSubject</span><span class="p">()</span><span class="o">:</span> <span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">'subject'</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getContent</span><span class="p">()</span><span class="o">:</span> <span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">'content'</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This will just generate an email with the subject <code class="highlighter-rouge">subject</code> and the content <code class="highlighter-rouge">content</code>. You can just extend the class and <a href="https://symfony.com/doc/current/service_container/autowiring.html">autowire</a> a twig environment into that to make life easier or a translator. Example in the <a href="https://github.com/disjfa/mail-bundle/blob/master/Example/ExampleMail.php">example</a> folder.</p>

<p>This will generate the default email when sent.</p>

<p>The original email must have curly braces which will parsed and used for parameters. So in the subject and the content it should look like.</p>

<!--  -->
<div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code>This is the email <span class="cp">{{</span> <span class="nv">email</span> <span class="cp">}}</span>
</code></pre></div></div>
<!--  -->

<p>When you do create a template using twig, please note that you cannot add twig tags directly. So escape them!</p>

<!--  -->
<div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code>This is the email <span class="cp">{{</span> <span class="s1">'{{'</span> <span class="cp">}}</span> email <span class="cp">{{</span> <span class="s1">'}}'</span> <span class="cp">}}</span>
</code></pre></div></div>
<!--  -->

<p>This will be read and checked for parameters. Only parameters made in the original content will be remembered in the system. For now we can also not implement fancy things like loops and extra stuff. The idea is to pre render data which you want to use and set those up as â€˜simpleâ€™ parameters.</p>

<h3 id="designing-emails">Designing emails</h3>

<p>So there is a thing called <a href="https://foundation.zurb.com/emails.html">Foundation for Emails</a>. Those guys made a thing for making hard email structures easy to set up. So there is a twig extension for <a href="https://github.com/twigphp/inky-extra">that</a>. Also somebody mage a way to inline css styling so we can make styling emails a bit easier on the eye. So there is a twig extension for <a href="https://github.com/twigphp/cssinliner-extra">that</a>.</p>

<p>So they made live wonderful for people that do not like emails. If you create an email that looks like this:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- a simplified example of the Inky syntax --&gt;</span>
<span class="nt">&lt;container&gt;</span>
    <span class="nt">&lt;row&gt;</span>
        <span class="nt">&lt;columns&gt;</span>This is the email .<span class="nt">&lt;/columns&gt;</span>
    <span class="nt">&lt;/row&gt;</span>
<span class="nt">&lt;/container&gt;</span>
</code></pre></div></div>

<p>It will be rendered and generated into something like this:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>garbage of table and data structure, what will look awesome in email clients!
</code></pre></div></div>

<p>The last item we did not render, it will be generated. We will let you check that in the console.</p>

<h3 id="cool-email-setup-send-them">Cool, email setup. Send them.</h3>

<p>Next up, it is up to you to send the emails. You have to tell your application to send an email wich you names. But we have made that simple. Lets check that out.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">use</span> <span class="nn">Disjfa\MailBundle\Mail\MailFactory</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Disjfa\MailBundle\Mail\MailService</span><span class="p">;</span>

<span class="k">function</span> <span class="nf">myFunction</span><span class="p">(</span><span class="nx">MailFactory</span> <span class="nv">$mailFactory</span><span class="p">,</span> <span class="nx">MailService</span> <span class="nv">$mailService</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$mail</span> <span class="o">=</span> <span class="nv">$mailFactory</span><span class="o">-&gt;</span><span class="na">findByName</span><span class="p">(</span><span class="s1">'app.example'</span><span class="p">);</span>
    <span class="nv">$mailService</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nv">$mail</span><span class="p">,</span> <span class="p">[</span>
         <span class="s1">'param1'</span> <span class="o">=&gt;</span> <span class="s1">'value'</span><span class="p">,</span>
         <span class="s1">'param2'</span> <span class="o">=&gt;</span> <span class="s1">'value'</span><span class="p">,</span>
    <span class="p">],</span> <span class="s1">'info@example.com'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And done, add this in a function you use and inject the correct data to send them. You can place this wherever. You can even setup the mailer to start sending the emails <a href="https://symfony.com/doc/current/mailer.html#sending-messages-async">async</a>.</p>

<h3 id="checking-the-emails">Checking the emails</h3>
<p>For checking the emails there is a command!</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">bin/console disjfa:mail:preview-mail</span>
</code></pre></div></div>
<p>This will result in a question, and list all the emails found in the application.</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">Please select an email</span>
  <span class="s">[0] disjfa_mail.example</span>
  <span class="s">[1] ... your email setup</span>
</code></pre></div></div>
<p>Next up, what to do?</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">What to do?</span>
  <span class="s">[0] preview</span>
  <span class="s">[1] preview raw</span>
  <span class="s">[2] send email</span>
</code></pre></div></div>
<p>Preview will just dump the base html. Preview raw will ask for all the parameters in the email and render it out dumping a pile of garbage of table and data structure, which should look awesome in an email application. The last will also ask for an email address and it will send out a test.</p>

<p>Nice! Now you can make, create and test the emails.</p>

<h3 id="edit-them">Edit them</h3>

<p>So now we have setup the emails, are able to make new email templates to use in your app. Now you just want to tweak them, they are never right for everyone. And anyone has their own opinion. So lets just edit them.</p>

<p>You can add the routes in a <code class="highlighter-rouge">config/routes/disjfa_mail.yaml</code> file.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">disjfa_mail</span><span class="pi">:</span>
    <span class="na">resource</span><span class="pi">:</span> <span class="s1">'</span><span class="s">@DisjfaMailBundle/Controller/'</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">annotation</span>
    <span class="na">prefix</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/admin'</span>
</code></pre></div></div>

<p>In this example the routes are annotated and mapped to the <code class="highlighter-rouge">/admin</code> folder, just as an example. This should end up in your application. So now you can open up the location. As an example on a localhost.</p>

<p><a href="https://localhost:8000/admin/mail-template">https://localhost:8000/admin/mail-template</a></p>

<p>Here is an overview of all emails in the system again! Cool. Here you can edit or preview them. If you edit one of them there will be subject and content edit area. And from the original html all the parameters are rendered and added as reference for your new template. Check it out in action.</p>

<p><img src="/img/assets/disjfa_mail.png" class="img-fluid" /></p>

<h3 id="as-for-the-templates">As for the templates</h3>

<p>For the template. There is just a basic layout adding some <a href="https://getbootstrap.com/">bootstrap</a> and there is some <a href="https://clipboardjs.com/">clipboardjs</a> added so it can be used. If you want to add the templates in your own you can just override the existing <code class="highlighter-rouge">layout.html.twig</code>. You can just add your own in <code class="highlighter-rouge">templates/bundles/DisjfaMailBundle/layout.html.twig</code>, just keep in mind to add the blocks needed.</p>

<p>The same is for the base email, but in this path <code class="highlighter-rouge">templates/bundles/DisjfaMailBundle/mail/email.html.twig</code>. Again, keep in mind the original blocks to implement. But here you can also just add your logo and other data you want to add.</p>

<h3 id="cool-now-what">Cool, now what?</h3>

<p>Now what? You can add your own and add custom emails in your applications. Send them as you like! Lets check what to do.</p>

<ul>
  <li>Create a class implementing <code class="highlighter-rouge">MailInterface</code>.</li>
  <li>Add some templates as needed.</li>
  <li>Add some translations as needed.</li>
  <li>Create a place in your application to send the emails.</li>
</ul>

<p>And done. You just created your first email and you did not even need to know much html to get them sending. It sounded like a lot, but in the end it was easy.</p>

<p>Now get on your way and create some awesome emails, and donâ€™t forget to send them!</p>
:ET